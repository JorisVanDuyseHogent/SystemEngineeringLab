# Documentatie Apache Web Server opzetten in virtuele machine en deployment op ubuntu server

| Documentatie type | Link |
| ----------- | ----------- |
| Online markdown documentation | [github.com](https://github.com/JorisVanDuyseHogent/SystemEngineeringLab/tree/main/ApacheWebServer#readme) |
| Online pdf documentation | [github.com](https://github.com/JorisVanDuyseHogent/SystemEngineeringLab/blob/main/ApacheWebServer/ApacheWebServerG56.pdf) |

## Table of Contents

- [Documentatie Apache Web Server opzetten in virtuele machine en deployment op ubuntu server](#documentatie-apache-web-server-opzetten-in-virtuele-machine-en-deployment-op-ubuntu-server)
  - [Table of Contents](#table-of-contents)
  - [Ubuntu desktop in Virtual box](#ubuntu-desktop-in-virtual-box)
  - [Ubuntu server on Bare-metal](#ubuntu-server-on-bare-metal)
    - [Niewe user aanmaken voor de webserver](#niewe-user-aanmaken-voor-de-webserver)
    - [Installatie Apache Web Server](#installatie-apache-web-server)
    - [Verwijderen van nginx](#verwijderen-van-nginx)
    - [Portforwardoing Apache2](#portforwardoing-apache2)
    - [Installatie van website voorbeeld](#installatie-van-website-voorbeeld)
    - [Http to Https with SSL](#http-to-https-with-ssl)
    - [SSL verbinding testen](#ssl-verbinding-testen)
    - [Eindresultaat](#eindresultaat)
    - [Extra informatie SSL certificaat](#extra-informatie-ssl-certificaat)

## Ubuntu desktop in Virtual box

Moet nog worden bijgewerkt

## Ubuntu server on Bare-metal

### Niewe user aanmaken voor de webserver

```bash
su #login to root user
adduser webserverg56
```

```bash
$ cat /etc/passwd | grep webserverg56 
webserverg56:x:1002:1002:,,,:/home/webserverg56:/bin/bash
```

```bash
usermod -aG sudo webserverg56
su - webserverg56
```

### Installatie Apache Web Server

```bash
sudo apt install apache2 -y
```

```bash
$ systemctl status apache2
‚óè apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
     Active: failed (Result: exit-code) since Fri 2022-03-18 16:32:58 UTC; 14s ago
       Docs: https://httpd.apache.org/docs/2.4/
```

!["ApacheInstallFailed"](./images/ApacheInstallFailed.PNG)
Na installatie en bij het runnen van systemctl status wordt duidelijk dat de server nog niet actief is.
Het probleem kon verholpen worden door nginx te verwijderen, hierdoor kwam poort 80 vrij; en kon apache2 gewoon worden geinsalleerd.

```bash
Mar 18 20:41:11 cplex apachectl[9167]: (98)Address already in use: AH00072: make_sock: could not bind to address [::]:80
Mar 18 20:41:11 cplex apachectl[9167]: (98)Address already in use: AH00072: make_sock: could not bind to address 0.0.0.0:80
```

### Verwijderen van nginx

```bash
lsof -i :80 #see what application is using port 80
sudo apt purge nginx nginx-common #for me nginx was using port 80 (not in use anymore)
systemctl stop apache2 #restart doesn't work
systemctl start apache2
systemctl status apache2
```

![Apach2Running](./images/Apach2Running.PNG)

### Portforwardoing Apache2

Apache2 gebruikt nu poort 80. Dus deze moeten we nu via onze ISP gaan open zetten.

```bash
$ lsof -i :80
COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
apache2 11933     root    4u  IPv6 131563      0t0  TCP *:http (LISTEN)
apache2 11934 www-data    4u  IPv6 131563      0t0  TCP *:http (LISTEN)
apache2 11935 www-data    4u  IPv6 131563      0t0  TCP *:http (LISTEN)
```

![PortForwardingSettings](./images/PortForwardingSettings.PNG)
*"Portforwarding van poort 80 voor apache2 (3306 en 22 voor sql-server en ssh)"*

![Apache2PortForwarded](./images/Apache2PortForwarded.PNG)
*"Benaderen van jorisduyse.com"*

### Installatie van website voorbeeld

```bash
$ ls
index.html  index.nginx-debian.html
$ sudo rm index.html | sudo rm index.nginx-debian.html #remove autogenerated index.html
```

```bash
$ sudo git clone https://github.com/bsclub/bsclub.github.io.git #clone old website example
Cloning into 'bsclub.github.io'...
remote: Enumerating objects: 342, done.
remote: Counting objects: 100% (342/342), done.
remote: Compressing objects: 100% (294/294), done.
remote: Total 342 (delta 49), reused 341 (delta 48), pack-reused 0
Receiving objects: 100% (342/342), 2.98 MiB | 16.78 MiB/s, done.
Resolving deltas: 100% (49/49), done.
```

```bash
$ ls #oops forgot about folder creation with git
bsclub.github.io  design.css  Fonts  Images  index.html  register.html
$ cd bsclub.github.io/
webserverg56@cplex:/var/www/html/bsclub.github.io$ sudo mv ./* ../
webserverg56@cplex:/var/www/html/bsclub.github.io$ cd ..
$ sudo rm -r ./bsclub.github.io/

$ ls #done!
bsclub.github.io  design.css  Fonts  Images  index.html  register.html
```

Eens een kijkje nemen naar de pagina die nu online staat!
![ExamplePage](./images/ExamplePage.PNG)

### Http to Https with SSL

Http &#128275; to Https &#128274; with SSL

```bash
$ sudo a2enmod ssl #enable the ssl service if not allready enabled
Considering dependency setenvif for ssl:
Module setenvif already enabled
Considering dependency mime for ssl:
Module mime already enabled
Considering dependency socache_shmcb for ssl:
Enabling module socache_shmcb.
Enabling module ssl.
See /usr/share/doc/apache2/README.Debian.gz on how to configure SSL and create self-signed certificates.
To activate the new configuration, you need to run:
  systemctl restart apache2
```

```bash
sudo service apache2 restart #restart apache2 for changes to take effect
```

Eerst maken we een backup van */etc/apache2/sites-available/default-ssl.conf*

```bash
sudo cp default-ssl.conf default-ssl.conf_back
```

We voegen volgende lijnen to aan het configuratie bestand */etc/apache2/sites-available/default-ssl.conf* onder **\<VirtualHost \_default_:443>**

```txt
ServerName jorisduyse.com
DocumentRoot /var/www/html
```

En onder **SSLEngine on** voegen we toe:
(Deze bestanden moeten uiteraard nog aangemaakt worden)

```txt
SSLCertificateFile      /etc/apache2/ssl/jorisduyse.com.crt
SSLCertificateKeyFile   /etc/apache2/ssl/jorisduyse.com.key
```

```bash
$ sudo mkdir /etc/apache2/ssl/sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -
keyout /etc/apache2/ssl/jorisduyse.com.key -out /etc/apache2/ssl/jorisduyse.com.crt
Generating a RSA private key
#**removed**
#**removed**
writing new private key to '/etc/apache2/ssl/jorisduyse.com.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:BE
State or Province Name (full name) [Some-State]:Oost-Vlaanderen
Locality Name (eg, city) []:Gent
Organization Name (eg, company) [Internet Widgits Pty Ltd]:jorisduyse
Organizational Unit Name (eg, section) []:jorisduyse
Common Name (e.g. server FQDN or YOUR name) []jorisduyse.com
Email Address []:jorisduyse@protonmail.com
```

![EnableSSLConfigFile](./images/EnableSSLConfigFile.PNG)
*"We schakelen de custom config file in en de oud die we voor http gebruikten uit"*

![PortForwarding443](./images/PortForwarding443.PNG)
*"Aangezien we een https verbinding willen maken en de http willen laten vallen kunnen we poort 80 weer sluiten"*

### SSL verbinding testen

Helaas gaat de browser nogsteeds klagen aangezien de SSL self-sigend is en dus niet "officieel" herkent wordt maar https is wel ingeschakeld.

![PotentialSecurityRisk](./images/PotentialSecurityRisk.PNG)
*"Browser klaagt over self-signed site"*

### Eindresultaat

![FinalResultSelfSignedSSLSite](./images/FinalResultSelfSignedSSLSite.PNG)

### Extra informatie SSL certificaat

![PageSecurityInfo](./images/PageSecurityInfo.PNG)
*"SSL certificaat informatie"*

![SelfSignedCertificate](./images/SelfSignedCertificate.PNG)
![SelfSignedCertificateRest](./images/SelfSignedCertificateRest.PNG)
*"Volledig SSL certificaat"*
